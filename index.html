<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda Espiritual ‚Äî Planner com Alarmes + Metas, Cron√¥metro e Leitura</title>
  <meta name="description" content="Agenda espiritual: calend√°rio com alarmes, metas por perfil (publicador/pioneiro), cron√¥metro do minist√©rio e plano de leitura b√≠blica (anual ou personalizado). 100% HTML/JS/CSS." />
  <style>
    :root{
      --bg:#0b1020; --card:#141a2e; --muted:#8aa3c7; --text:#eaf2ff; --accent:#5cc8ff; --ok:#3ddc97; --warn:#ffd166; --danger:#ff6b6b;
      --c-ministerio:#4f46e5; --c-familia:#ef4444; --c-trabalho:#f59e0b; --c-reuniao:#10b981; --c-cong:#a855f7; --c-leitura:#22c55e; --c-apoio:#06b6d4; --c-custom:#eab308;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#09122a 0%, var(--bg) 100%);color:var(--text);font:500 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",sans-serif}
    a{color:var(--accent)}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{font-weight:800;letter-spacing:.2px;font-size:22px}
    .bar{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:10px 14px;border:1px solid #2a335a;border-radius:12px;background:#0f1530;color:var(--text);cursor:pointer;transition:.15s}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(135deg,#2c3e8f,#5b6cff);border-color:#39408a;color:white}
    .btn.ghost{background:transparent}
    .btn.small{padding:6px 9px;border-radius:10px;font-size:14px}

    .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid #212a4a;border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.18);margin-bottom:14px}

    .legend{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;gap:8px;align-items:center;border-radius:999px;padding:6px 10px;background:#101633;border:1px solid #23315e;color:#cfe4ff;font-size:12px}
    .dot{width:10px;height:10px;border-radius:50%}

    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:14px;margin-top:14px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:580px){.grid{grid-template-columns:1fr}}
    .col{background:rgba(255,255,255,.02);border:1px solid #1d2442;border-radius:14px;padding:10px;min-height:220px}
    .col h3{margin:2px 2px 10px;font-size:14px;font-weight:800;color:#bcd5ff;display:flex;justify-content:space-between;align-items:center}
    .event{border-radius:12px;padding:8px 10px;margin:8px 0;background:#0f1530;border:1px solid #263059;box-shadow:0 4px 16px rgba(0,0,0,.15);cursor:pointer}
    .event .t{font-weight:800}
    .event .info{font-size:12px;color:#b8c8e6;opacity:.9;margin-top:2px}
    .tag{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06)}

    .muted{color:var(--muted)}
    .footer{opacity:.75;font-size:13px;margin-top:14px}

    dialog{border:none;border-radius:18px;padding:0;max-width:760px;width:96vw;background:var(--card);color:var(--text);box-shadow:0 24px 70px rgba(0,0,0,.4)}
    .modal{padding:18px}
    .modal h2{margin:0 0 10px;font-size:20px}
    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:640px){.grid2{grid-template-columns:1fr}}
    label{font-size:13px;color:#c9dcff;display:block}
    input,select,textarea{width:100%;margin-top:6px;background:#0f1530;border:1px solid #2a335a;color:#eaf2ff;border-radius:10px;padding:10px}
    input[type="datetime-local"], input[type="date"], input[type="time"]{color-scheme:dark}

    .line{height:1px;background:#223056;margin:12px 0}
    .dash{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin:14px 0}
    @media (max-width:1000px){.dash{grid-template-columns:1fr 1fr}}
    @media (max-width:700px){.dash{grid-template-columns:1fr}}

    .progress{height:12px;border-radius:999px;background:#101633;border:1px solid #23315e;position:relative;overflow:hidden;margin-top:8px}
    .progress .bar{height:100%;background:linear-gradient(90deg,var(--ok),var(--accent));border-radius:999px;width:0%}
    .kpi{display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:13px;color:var(--muted)}

    .timer{display:flex;flex-direction:column;gap:10px}
    .timer .display{font-size:34px;font-weight:800;letter-spacing:1px;text-align:center}
    .timer .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}

    .read-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){.read-row{grid-template-columns:1fr}}

    /* Fallback de dialog se browser n√£o suportar */
    .fallback-open{display:block !important;position:fixed;inset:10%;background:var(--card);border:1px solid #212a4a;border-radius:16px;z-index:1000;overflow:auto}

    /* Caixa de erro */
    #errbox{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#3b1d1d;color:#ffdada;border:1px solid #6e2a2a;padding:10px 14px;border-radius:10px;display:none;z-index:2000}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="row">
        <div class="title">Agenda Espiritual ‚Äî Planner com Alarmes</div>
        <button class="btn small ghost" id="btnPerms" title="Ativar notifica√ß√µes">üîî Ativar notifica√ß√µes</button>
      </div>
      <div class="bar">
        <button class="btn" id="btnPrev">‚óÄ Semana anterior</button>
        <div class="row"><span id="weekLabel" class="muted"></span></div>
        <button class="btn" id="btnNext">Semana seguinte ‚ñ∂</button>
        <button class="btn primary" id="btnNew">Ôºã Novo compromisso</button>
        <button class="btn ghost" id="btnExport">‚¨áÔ∏è Exportar</button>
        <button class="btn ghost" id="btnImport">‚¨ÜÔ∏è Importar</button>
        <select id="themeSelect" class="btn">
          <option value="slate">Tema: Escuro (padr√£o)</option>
          <option value="light">Tema: Claro</option>
          <option value="sky">Tema: C√©u</option>
          <option value="sand">Tema: Areia</option>
          <option value="forest">Tema: Floresta</option>
          <option value="sunrise">Tema: Amanhecer</option>
        </select>
        <input type="file" id="fileImport" accept="application/json" hidden />
      </div>
    </header>

    <div class="legend card">
      <span class="chip"><span class="dot" style="background:var(--c-ministerio)"></span> Minist√©rio</span>
      <span class="chip"><span class="dot" style="background:var(--c-familia)"></span> Adora√ß√£o em fam√≠lia</span>
      <span class="chip"><span class="dot" style="background:var(--c-trabalho)"></span> Trabalho secular</span>
      <span class="chip"><span class="dot" style="background:var(--c-reuniao)"></span> Reuni√µes</span>
      <span class="chip"><span class="dot" style="background:var(--c-cong)"></span> Congrega√ß√£o ‚Äî Arranjos</span>
      <span class="chip"><span class="dot" style="background:var(--c-leitura)"></span> Leitura di√°ria</span>
      <span class="chip"><span class="dot" style="background:var(--c-apoio)"></span> Ajudar o pr√≥ximo</span>
      <span class="chip"><span class="dot" style="background:var(--c-custom)"></span> Personalizado</span>
    </div>

    <section class="dash">
      <!-- Perfil & Metas -->
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <strong>Perfil & Metas do Minist√©rio</strong>
          <button class="btn small ghost" id="btnProfile">‚öôÔ∏è Ajustar</button>
        </div>
        <div class="muted" id="profileSummary" style="margin-top:8px">‚Äî</div>
        <div class="progress" style="margin-top:10px"><div class="bar" id="hrsBar"></div></div>
        <div class="kpi"><span id="hrsKpi">0:00 / ‚Äî</span><span id="hrsPct">0%</span></div>
      </div>

      <!-- Cron√¥metro -->
      <div class="card">
        <strong>‚è±Ô∏è Cron√¥metro do Minist√©rio</strong>
        <div class="timer">
          <div class="display" id="timerDisp">00:00:00</div>
          <div class="controls">
            <button class="btn primary" id="tStart">Iniciar</button>
            <button class="btn" id="tPause">Pausar</button>
            <button class="btn ghost" id="tReset">Zerar</button>
            <button class="btn" id="tSave">Salvar no calend√°rio</button>
          </div>
          <div class="muted" style="text-align:center">Ao salvar, cria um compromisso ‚ÄúMinist√©rio (Cron√¥metro)‚Äù com o per√≠odo cronometrado.</div>
        </div>
      </div>

      <!-- Leitura B√≠blica -->
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <strong>üìñ Plano de Leitura da B√≠blia</strong>
          <button class="btn small ghost" id="btnRead">Configurar</button>
        </div>
        <div class="muted" style="margin-top:8px" id="readSummary">Gere um plano anual ou personalizado. Os blocos entram no calend√°rio como ‚ÄúLeitura: ‚Ä¶‚Äù.</div>
        <div class="row" style="margin-top:10px;gap:8px">
          <button class="btn" id="btnClearRead">üóëÔ∏è Remover eventos de Leitura</button>
        </div>
      </div>
    </section>

    <!-- Semana -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="muted">Clique em ‚ÄúNovo compromisso‚Äù para adicionar. Dados ficam no seu navegador (LocalStorage). Alarmes tocam com a aba aberta e notifica√ß√µes ativadas.</div>
      </div>
      <div class="grid" id="grid"></div>
      <div class="footer">Dica: exporte seu plano periodicamente para backup. ‚è∞</div>
    </section>
  </div>

  <!-- Dialog: Compromisso -->
  <dialog id="dlg">
    <form class="modal" method="dialog" id="formEvt">
      <h2 id="dlgTitle">Novo compromisso</h2>
      <div class="grid2">
        <div><label>T√≠tulo<input required id="f_title" placeholder="Ex.: Minist√©rio em grupo" /></label></div>
        <div><label>Categoria
          <select id="f_cat">
            <option value="ministerio">Minist√©rio</option>
            <option value="familia">Adora√ß√£o em fam√≠lia</option>
            <option value="trabalho">Trabalho secular</option>
            <option value="reuniao">Reuni√µes</option>
            <option value="cong">Congrega√ß√£o ‚Äî Arranjos</option>
            <option value="leitura">Leitura di√°ria</option>
            <option value="apoio">Ajudar o pr√≥ximo</option>
            <option value="custom">Personalizado</option>
          </select></label></div>
        <div><label>Data<input type="date" id="f_date" required /></label></div>
        <div><label>In√≠cio<input type="time" id="f_start" required /></label></div>
        <div><label>Fim<input type="time" id="f_end" required /></label></div>
        <div><label>Lembrete (min. antes)<input type="number" id="f_rem" min="0" step="5" placeholder="Ex.: 10" /></label></div>
        <div><label>Repetir?
          <select id="f_repeat"><option value="none">N√£o</option><option value="daily">Diariamente</option><option value="weekly">Semanal</option></select></label></div>
        <div><label>Qtd. de repeti√ß√µes<input type="number" id="f_repeatCount" min="1" max="365" placeholder="Ex.: 30" /></label></div>
        <div><label>Notas<input id="f_notes" placeholder="Detalhes, endere√ßos, tarefas..." /></label></div>
      </div>
      <div class="line"></div>
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <button class="btn" value="cancel">Cancelar</button>
          <button class="btn primary" id="btnSave" value="default">Salvar</button>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn danger" id="btnDelete" type="button" style="display:none;background:linear-gradient(135deg,#8b1d1d,#ff5a5a);border-color:#8b1d1d">Excluir</button>
        </div>
      </div>
      <input type="hidden" id="f_id" />
    </form>
  </dialog>

  <!-- Dialog: Perfil -->
  <dialog id="dlgProfile">
    <form class="modal" method="dialog" id="formProfile">
      <h2>Perfil & Metas do Minist√©rio</h2>
      <div class="grid2">
        <div><label>Perfil
          <select id="p_type">
            <option value="publicador">Publicador</option>
            <option value="pr_regular">Pioneiro regular</option>
            <option value="pr_aux">Pioneiro auxiliar</option>
          </select></label></div>
        <div><label>Meta personalizada (horas/m√™s ‚Äî opcional)
          <input type="number" id="p_custom" min="0" step="1" placeholder="Ex.: 10" /></label></div>
        <div id="auxBlock"><label>Auxiliar ‚Äî alvo do m√™s (15h ou 30h)
          <select id="p_auxTarget"><option value="15">15</option><option value="30">30</option></select></label></div>
        <div id="auxMonthOnlyBlock"><label>Aplicar s√≥ neste m√™s?
          <select id="p_auxOnly"><option value="yes">Sim</option><option value="no">N√£o (at√© mudar)</option></select></label></div>
      </div>
      <div class="line"></div>
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <button class="btn" value="cancel">Fechar</button>
          <button class="btn primary" id="btnSaveProfile" value="default">Salvar</button>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn ghost" id="btnResetMonth" type="button">Zerar progresso do m√™s</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Dialog: Leitura -->
  <dialog id="dlgRead">
    <form class="modal" method="dialog" id="formRead">
      <h2>Plano de Leitura da B√≠blia</h2>
      <div class="read-row">
        <div><label>Tipo de plano
          <select id="r_type"><option value="anual">Capa a capa (1 ano)</option><option value="personalizado">Personalizado</option></select></label></div>
        <div><label>In√≠cio<input type="date" id="r_start" /></label></div>
        <div id="r_personalized"><label>M√©todo
          <select id="r_method"><option value="cap_dia">Cap√≠tulos por dia</option><option value="dias_total">Terminar em (dias)</option></select></label></div>
        <div id="r_capdia"><label>N¬∫ de cap√≠tulos por dia
          <input type="number" id="r_chapsPerDay" min="1" max="20" step="1" value="3" /></label></div>
        <div id="r_dias"><label>Terminar em quantos dias?
          <input type="number" id="r_totalDays" min="1" max="1000" step="1" value="365" /></label></div>
        <div><label>Hora de leitura
          <input type="time" id="r_time" value="07:00" /></label></div>
        <div><label>Dura√ß√£o estimada por dia (min)
          <input type="number" id="r_minPerDay" min="5" max="180" step="5" value="30" /></label></div>
        <div><label>Lembrete (min. antes)
          <input type="number" id="r_rem" min="0" step="5" value="10" /></label></div>
      </div>
      <div class="line"></div>
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <button class="btn" value="cancel">Cancelar</button>
          <button class="btn primary" id="btnGenRead" value="default">Gerar plano</button>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn" id="btnWipeRead" type="button" style="background:linear-gradient(135deg,#8b1d1d,#ff5a5a);border-color:#8b1d1d">Remover plano atual</button>
        </div>
      </div>
    </form>
  </dialog>

  <div id="errbox"></div>
  <audio id="beep" preload="auto"></audio>

  <script>
  (function(){
    function err(msg){var b=document.getElementById('errbox'); b.textContent=msg; b.style.display='block'; setTimeout(function(){b.style.display='none'},8000); if(window.console&&console.error) console.error(msg); }
    window.addEventListener('error', function(e){ err('Erro: '+(e.message||e)); });

    function $(s){return document.querySelector(s)}
    function $$(s){return Array.prototype.slice.call(document.querySelectorAll(s))}
    function pad(n){return (n<10?'0':'')+n}
    function fmtDate(d){return d.toLocaleDateString('pt-BR',{weekday:'short', day:'2-digit', month:'2-digit'})}
    function todayYMD(){ var d=new Date(); return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
    function combine(ymd,hm){ return new Date(ymd+'T'+hm+':00') }
    function startOfWeek(d){ var x=new Date(d); var day=(x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x; }
    function addDays(d,n){ var x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function ymKey(d){ if(!d) d=new Date(); return d.getFullYear()+'-'+pad(d.getMonth()+1); }

        var CAT = {
      ministerio:{name:'Minist√©rio', color:'var(--c-ministerio)'},
      familia:{name:'Adora√ß√£o em fam√≠lia', color:'var(--c-familia)'},
      trabalho:{name:'Trabalho secular', color:'var(--c-trabalho)'},
      reuniao:{name:'Reuni√µes', color:'var(--c-reuniao)'},
      cong:{name:'Congrega√ß√£o ‚Äî Arranjos', color:'var(--c-cong)'},
      leitura:{name:'Leitura di√°ria', color:'var(--c-leitura)'},
      apoio:{name:'Ajudar o pr√≥ximo', color:'var(--c-apoio)'},
      custom:{name:'Personalizado', color:'var(--c-custom)'}
    };

    function loadEvents(){ try{return JSON.parse(localStorage.getItem('events_v1')||'[]')}catch(e){return []} }
    function saveEvents(){ localStorage.setItem('events_v1',JSON.stringify(state.events)); scheduleAllAlarms(); render(); updateDashboard(); }
    function loadProfile(){ 
      try{ 
        var p=JSON.parse(localStorage.getItem('profile_v1')||'{}'); 
        var base={type:'publicador',customTarget:null,auxTarget:15,auxOnly:true,auxMonth:ymKey(new Date())};
        for(var k in p){ base[k]=p[k]; }
        return base;
      }catch(e){ return {type:'publicador',customTarget:null,auxTarget:15,auxOnly:true,auxMonth:ymKey(new Date())} } 
    }
    function saveProfile(){ localStorage.setItem('profile_v1',JSON.stringify(state.profile)); updateDashboard(); }

    var state={ weekStart:startOfWeek(new Date()), events:loadEvents(), profile:loadProfile() };

    // Polyfill "dialog"
    function openDialog(el){ if(el && el.showModal) el.showModal(); else if(el) el.classList.add('fallback-open'); }
    function closeDialog(el){ if(!el) return; try{ if(el.close) el.close(); }catch(e){}; el.classList.remove('fallback-open'); }

    function render(){
      try{
        var start=state.weekStart, end=addDays(start,6);
        $('#weekLabel').textContent=fmtDate(start)+' ‚Üí '+fmtDate(end);
        var grid=$('#grid'); grid.innerHTML='';
        for(var i=0;i<7;i++){
          var d=addDays(start,i); var ymd=d.toISOString().slice(0,10);
          var col=document.createElement('div'); col.className='col';
          var h=document.createElement('h3');
          var wname=d.toLocaleDateString('pt-BR',{weekday:'long'});
          h.innerHTML='<span style="text-transform:capitalize">'+wname+'</span><span class="tag">'+d.toLocaleDateString('pt-BR')+'</span>';
          col.appendChild(h);
          var dayEvents=state.events.filter(function(ev){return ev.date===ymd}).sort(function(a,b){return (a.start||'').localeCompare(b.start||'')});
          if(dayEvents.length===0){ var p=document.createElement('div'); p.className='muted'; p.textContent='(sem compromissos)'; col.appendChild(p); }
          else { for(var j=0;j<dayEvents.length;j++){ col.appendChild(renderEvent(dayEvents[j])); } }
          grid.appendChild(col);
        }
      }catch(e){ err('Falha ao renderizar: '+e.message); }
    }

    function renderEvent(ev){
      var el=document.createElement('div'); el.className='event';
      var cat = CAT[ev.cat];
      el.style.borderLeft='6px solid '+(cat ? cat.color : '#64748b');
      el.innerHTML = '<div class="t">'+ev.title+'</div>'
        + '<div class="info">'+ev.start+'‚Äì'+ev.end+' ‚Ä¢ <span class="tag" style="border-color:'+(cat?cat.color:'')+';color:'+(cat?cat.color:'')+'">'+(cat?cat.name:'‚Äî')+'</span></div>'
        + (ev.notes?'<div class="info">'+ev.notes+'</div>':'')
        + ((ev.rem||ev.rem===0)?'<div class="info">üîî Lembrete: '+ev.rem+' min antes</div>':'');
      el.addEventListener('click', function(){ openEventModal(ev); });
      return el;
    }

    function openEventModal(ev){
      var dlg=$('#dlg');
      $('#dlgTitle').textContent = ev ? 'Editar compromisso' : 'Novo compromisso';
      $('#f_id').value = ev ? ev.id : '';
      $('#f_title').value = ev ? (ev.title||'') : '';
      $('#f_cat').value = ev ? ev.cat : 'ministerio';
      $('#f_date').value = ev ? (ev.date||todayYMD()) : todayYMD();
      $('#f_start').value = ev ? (ev.start||'08:00') : '08:00';
      $('#f_end').value = ev ? (ev.end||'09:00') : '09:00';
      $('#f_rem').value = (ev && (ev.rem||ev.rem===0)) ? ev.rem : '';
      $('#f_repeat').value = ev ? (ev.repeat||'none') : 'none';
      $('#f_repeatCount').value = ev ? (ev.repeatCount||'') : '';
      $('#f_notes').value = ev ? (ev.notes||'') : '';
      $('#btnDelete').style.display = ev ? 'inline-flex':'none';
      updateRepeatCountState();
      openDialog(dlg);
    }

    function updateRepeatCountState(){
      var rep=$('#f_repeat').value; var fld=$('#f_repeatCount');
      if(rep==='none'){ fld.disabled=true; fld.placeholder='‚Äî'; fld.value=''; }
      else { fld.disabled=false; fld.placeholder = (rep==='daily'? 'dias (ex.: 30)' : 'semanas (ex.: 8)'); }
    }

    function saveFromForm(){
      var id=$('#f_id').value || (Date.now()+"_"+Math.random().toString(36).slice(2));
      var remStr=$('#f_rem').value;
      var rcountStr=$('#f_repeatCount').value;
      var rcount = parseInt(rcountStr,10);
      var ev={
        id:id,
        title:($('#f_title').value||'').trim(),
        cat:$('#f_cat').value,
        date:$('#f_date').value,
        start:$('#f_start').value,
        end:$('#f_end').value,
        rem:(remStr!==''? parseInt(remStr,10): null),
        repeat:$('#f_repeat').value,
        repeatCount:(Number.isFinite?Number.isFinite(rcount):!isNaN(rcount)) && rcount>0 ? rcount : null,
        notes:($('#f_notes').value||'').trim()
      };
      if(!ev.title||!ev.date||!ev.start||!ev.end){ err('Preencha t√≠tulo, data, in√≠cio e fim.'); return; }
      var idx=-1; for(var i=0;i<state.events.length;i++){ if(state.events[i].id===id){ idx=i; break; } }
      if(idx>=0) state.events[idx]=ev; else state.events.push(ev);

      if(!$('#f_id').value){
        var countWeeklyDefault=8, countDailyDefault=30;
        if(ev.repeat==='weekly'){
          var times=ev.repeatCount||countWeeklyDefault;
          for(var w=1;w<=times;w++){ var nd=addDays(new Date(ev.date),7*w); state.events.push({id:id+"w"+w,title:ev.title,cat:ev.cat,date:nd.toISOString().slice(0,10),start:ev.start,end:ev.end,rem:ev.rem,repeat:'none',repeatCount:null,notes:ev.notes}); }
        }else if(ev.repeat==='daily'){
          var td=ev.repeatCount||countDailyDefault;
          for(var d=1;d<=td;d++){ var nd2=addDays(new Date(ev.date),d); state.events.push({id:id+"d"+d,title:ev.title,cat:ev.cat,date:nd2.toISOString().slice(0,10),start:ev.start,end:ev.end,rem:ev.rem,repeat:'none',repeatCount:null,notes:ev.notes}); }
        }
      }
      saveEvents();
      closeDialog($('#dlg'));
    }

    function deleteFromForm(){
      var id=$('#f_id').value; if(!id) return;
      state.events = state.events.filter(function(e){return e.id!==id});
      saveEvents();
      closeDialog($('#dlg'));
    }

    function ensurePerms(){
      try{
        if(!('Notification' in window)){ err('Seu navegador n√£o suporta notifica√ß√µes.'); return; }
        if(Notification.permission!=='granted'){
          Notification.requestPermission().then(function(p){ if(p!=='granted'){ err('Notifica√ß√µes n√£o autorizadas.'); } });
        }
      }catch(e){ err('Falha nas permiss√µes: '+e.message); }
                                                                                           }

    var timers=[];
    function clearTimers(){ for(var i=0;i<timers.length;i++) clearTimeout(timers[i]); timers=[]; }
    function scheduleAllAlarms(){
      clearTimers();
      var now=Date.now();
      state.events.forEach(function(ev){
        if(!(ev.rem||ev.rem===0)) return;
        var start=combine(ev.date,ev.start).getTime();
        var when=start - ev.rem*60000;
        if(when>now){
          var t=setTimeout(function(){ notifyEvent(ev) }, when-now);
          timers.push(t);
        }
      });
    }
    function notifyEvent(ev){
      try{ var beep=$('#beep'); if(beep){ beep.src='data:audio/mp3;base64,//uQZAAAAA'; var pr=beep.play(); if(pr && pr.catch) pr.catch(function(){}); } }catch(_){}
      if('Notification' in window && Notification.permission==='granted'){
        try{ var n=new Notification('‚è∞ Lembrete: '+ev.title,{ body: ev.date+' '+ev.start+' ('+(CAT[ev.cat]?CAT[ev.cat].name:'')+')', tag:ev.id}); n.onclick=function(){window.focus()}; }catch(_){}
      }
    }

    function exportJSON(){
      var blob=new Blob([JSON.stringify(state.events,null,2)],{type:'application/json'});
      var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='agenda-espiritual.json'; a.click(); URL.revokeObjectURL(url);
    }
    function importJSON(file){
      var r=new FileReader(); r.onload=function(){ try{ state.events=JSON.parse(r.result||'[]'); saveEvents(); }catch(e){ err('Arquivo inv√°lido.'); } }; r.readAsText(file);
    }

    function minutesBetween(ev){ try{ var s=combine(ev.date,ev.start).getTime(); var e=combine(ev.date,ev.end).getTime(); return Math.max(0, Math.floor((e-s)/60000)); }catch(_){ return 0; } }
    function monthlyMinutes(y,m){
      var ym=y+'-'+pad(m);
      return state.events.filter(function(ev){return ev.cat==='ministerio' && ev.date && ev.date.indexOf(ym)===0}).map(minutesBetween).reduce(function(a,b){return a+b},0);
    }
    function targetMinutes(y,m){
      var p=state.profile;
      if(p.customTarget && p.customTarget>0) return p.customTarget*60;
      if(p.type==='pr_regular') return 50*60;
      if(p.type==='pr_aux'){
        if(p.auxOnly){ if(p.auxMonth===y+'-'+pad(m)) return p.auxTarget*60; else return 0; }
        return p.auxTarget*60;
      }
      return null;
    }
    function hhmm(mins){ var h=Math.floor(mins/60), mm=mins%60; return pad(h)+':'+pad(mm); }
    function updateDashboard(){
      var now=new Date(); var mins=monthlyMinutes(now.getFullYear(),now.getMonth()+1); var tgt=targetMinutes(now.getFullYear(),now.getMonth()+1);
      var bar=$('#hrsBar'), kpi=$('#hrsKpi'), pct=$('#hrsPct');
      if(tgt===null){ bar.style.width='0%'; kpi.textContent=hhmm(mins)+' / ‚Äî'; pct.textContent='‚Äî'; }
      else { var p=Math.min(100,Math.round((mins/tgt)*100)); bar.style.width=p+'%'; kpi.textContent=hhmm(mins)+' / '+hhmm(tgt); pct.textContent=p+'%'; }
      var pr=state.profile; var desc='Perfil: ';
      if(pr.type==='publicador') desc+='Publicador';
      if(pr.type==='pr_regular') desc+='Pioneiro regular (meta 50h/m√™s)';
      if(pr.type==='pr_aux') desc+='Pioneiro auxiliar ('+pr.auxTarget+'h '+(pr.auxOnly?'‚Äî s√≥ no m√™s configurado':'por m√™s')+')';
      if(pr.customTarget && pr.customTarget>0) desc+=' ‚Ä¢ Meta personalizada: '+pr.customTarget+'h/m√™s';
      $('#profileSummary').textContent=desc;
    }

    // Cron√¥metro
    var tInterval=null, tStart=0, tAccum=0, tRunning=false;
    function formatHMS(ms){ var sec=Math.floor(ms/1000); var h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; return pad(h)+':'+pad(m)+':'+pad(s); }
    function timerUpdate(){ $('#timerDisp').textContent = formatHMS(tAccum + (tRunning? Date.now()-tStart : 0)); }
    function timerStart(){ if(!tRunning){ tRunning=true; tStart=Date.now(); tInterval=setInterval(timerUpdate,500); timerUpdate(); } }
    function timerPause(){ if(tRunning){ tAccum += Date.now()-tStart; tRunning=false; clearInterval(tInterval); timerUpdate(); } }
    function timerReset(){ tRunning=false; clearInterval(tInterval); tAccum=0; tStart=0; timerUpdate(); }
    function timerSaveToCalendar(){
      var totalMs=tAccum + (tRunning? Date.now()-tStart : 0);
      if(totalMs<60000){ err('M√≠nimo de 1 minuto para salvar.'); return; }
      var now=new Date(); var end=now; var start=new Date(now.getTime()-totalMs);
      var dateYMD=todayYMD(); var startHM=pad(start.getHours())+':'+pad(start.getMinutes()); var endHM=pad(end.getHours())+':'+pad(end.getMinutes());
      if(start.toDateString()!==end.toDateString()) startHM='00:00';
      var id=Date.now()+"_cronometro";
      var ev={id:id,title:'Minist√©rio (Cron√¥metro)',cat:'ministerio',date:dateYMD,start:startHM,end:endHM,rem:null,repeat:'none',notes:'Registro via cron√¥metro'};
      state.events.push(ev); saveEvents(); timerReset();
    }

    // Leitura
    var BIBLE=[
      {abbr:'Gn',name:'G√™nesis',ch:50},{abbr:'√äx',name:'√äxodo',ch:40},{abbr:'Lv',name:'Lev√≠tico',ch:27},{abbr:'Nm',name:'N√∫meros',ch:36},{abbr:'Dt',name:'Deuteron√¥mio',ch:34},
      {abbr:'Js',name:'Josu√©',ch:24},{abbr:'Jz',name:'Ju√≠zes',ch:21},{abbr:'Rt',name:'Rute',ch:4},{abbr:'1Sm',name:'1 Samuel',ch:31},{abbr:'2Sm',name:'2 Samuel',ch:24},
      {abbr:'1Rs',name:'1 Reis',ch:22},{abbr:'2Rs',name:'2 Reis',ch:25},{abbr:'1Cr',name:'1 Cr√¥nicas',ch:29},{abbr:'2Cr',name:'2 Cr√¥nicas',ch:36},{abbr:'Ed',name:'Esdras',ch:10},
      {abbr:'Ne',name:'Neemias',ch:13},{abbr:'Et',name:'Ester',ch:10},{abbr:'J√≥',name:'J√≥',ch:42},{abbr:'Sl',name:'Salmos',ch:150},{abbr:'Pv',name:'Prov√©rbios',ch:31},
      {abbr:'Ec',name:'Eclesiastes',ch:12},{abbr:'Ct',name:'C√¢ntico de Salom√£o',ch:8},{abbr:'Is',name:'Isa√≠as',ch:66},{abbr:'Jr',name:'Jeremias',ch:52},{abbr:'Lm',name:'Lamenta√ß√µes',ch:5},
      {abbr:'Ez',name:'Ezequiel',ch:48},{abbr:'Dn',name:'Daniel',ch:12},{abbr:'Os',name:'Os√©ias',ch:14},{abbr:'Jl',name:'Joel',ch:3},{abbr:'Am',name:'Am√≥s',ch:9},
      {abbr:'Ob',name:'Obadias',ch:1},{abbr:'Jn',name:'Jonas',ch:4},{abbr:'Mq',name:'Miqu√©ias',ch:7},{abbr:'Na',name:'Naum',ch:3},{abbr:'Hc',name:'Habacuque',ch:3},
      {abbr:'Sf',name:'Sofonias',ch:3},{abbr:'Ag',name:'Ageu',ch:2},{abbr:'Zc',name:'Zacarias',ch:14},{abbr:'Ml',name:'Malaquias',ch:4},
      {abbr:'Mt',name:'Mateus',ch:28},{abbr:'Mc',name:'Marcos',ch:16},{abbr:'Lc',name:'Lucas',ch:24},{abbr:'Jo',name:'Jo√£o',ch:21},{abbr:'At',name:'Atos',ch:28},
      {abbr:'Rm',name:'Romanos',ch:16},{abbr:'1Co',name:'1 Cor√≠ntios',ch:16},{abbr:'2Co',name:'2 Cor√≠ntios',ch:13},{abbr:'Gl',name:'G√°latas',ch:6},{abbr:'Ef',name:'Ef√©sios',ch:6},
      {abbr:'Fp',name:'Filipenses',ch:4},{abbr:'Cl',name:'Colossenses',ch:4},{abbr:'1Ts',name:'1 Tessalonicenses',ch:5},{abbr:'2Ts',name:'2 Tessalonicenses',ch:3},
      {abbr:'1Tm',name:'1 Tim√≥teo',ch:6},{abbr:'2Tm',name:'2 Tim√≥teo',ch:4},{abbr:'Tt',name:'Tito',ch:3},{abbr:'Fm',name:'Filemom',ch:1},{abbr:'Hb',name:'Hebreus',ch:13},
      {abbr:'Tg',name:'Tiago',ch:5},{abbr:'1Pe',name:'1 Pedro',ch:5},{abbr:'2Pe',name:'2 Pedro',ch:3},{abbr:'1Jo',name:'1 Jo√£o',ch:5},{abbr:'2Jo',name:'2 Jo√£o',ch:1},
      {abbr:'3Jo',name:'3 Jo√£o',ch:1},{abbr:'Jd',name:'Judas',ch:1},{abbr:'Ap',name:'Revela√ß√£o',ch:22}
    ];
    var TOTAL_CHAPS=BIBLE.reduce(function(a,b){return a+b.ch},0);

    function buildDailyRefs(startDate, planDays){
      var base=new Date(startDate); var per=Math.floor(TOTAL_CHAPS/planDays); var extra=TOTAL_CHAPS%planDays;
      var curBook=0, curChap=1; var days=[];
      for(var d=0; d<planDays; d++){
        var dayChaps=per+(extra>0?1:0); if(extra>0) extra--;
        var remain=dayChaps; var segs=[];
        while(remain>0 && curBook<BIBLE.length){
          var book=BIBLE[curBook]; var start=curChap; var can=Math.min(remain, book.ch-(curChap-1)); var end=curChap+can-1;
          segs.push(book.abbr+' '+(start===end? start : (start+'-'+end)));
          remain-=can; curChap=end+1; if(curChap>book.ch){ curBook++; curChap=1; }
        }
        var dateYMD=base.toISOString().slice(0,10); days.push({date:dateYMD, ref:segs.join('; ')}); base.setDate(base.getDate()+1);
        if(curBook>=BIBLE.length) break;
      }
      return days;
    }
    function buildDailyRefsByChaps(startDate, chapsPerDay){
      var base=new Date(startDate); var remainTotal=TOTAL_CHAPS; var curBook=0, curChap=1; var days=[];
      while(remainTotal>0){
        var per=Math.min(chapsPerDay, remainTotal); var r=per; var segs=[];
        while(r>0 && curBook<BIBLE.length){
          var book=BIBLE[curBook]; var start=curChap; var can=Math.min(r, book.ch-(curChap-1)); var end=curChap+can-1;
          segs.push(book.abbr+' '+(start===end? start : (start+'-'+end)));
          r-=can; curChap=end+1; if(curChap>book.ch){ curBook++; curChap=1; }
        }
        var dateYMD=base.toISOString().slice(0,10); days.push({date:dateYMD, ref:segs.join('; ')}); base.setDate(base.getDate()+1); remainTotal-=per;
      }
      return days;
    }
    function genReadPlan(){
      var type=$('#r_type').value; var start=$('#r_start').value||todayYMD(); var time=$('#r_time').value||'07:00';
      var minDay=parseInt($('#r_minPerDay').value,10)||30; var rem=parseInt($('#r_rem').value,10)||0;
      var days=[];
      if(type==='anual'){ days=buildDailyRefs(start,365); }
      else {
        var method=$('#r_method').value;
        if(method==='cap_dia'){ var cpd=parseInt($('#r_chapsPerDay').value,10); if(!cpd||cpd<1) cpd=3; days=buildDailyRefsByChaps(start, Math.min(20,cpd)); }
        else { var td=parseInt($('#r_totalDays').value,10); if(!td||td<1) td=365; days=buildDailyRefs(start, Math.min(1000,td)); }
      }
      var idBase=Date.now()+"_leitura_";
      days.forEach(function(d,i){
        var startDate=new Date(d.date+'T'+time+':00'); var endDate=new Date(startDate.getTime()+minDay*60000);
        var ev={id:idBase+i,title:'Leitura: '+d.ref,cat:'leitura',date:d.date,
          start:pad(startDate.getHours())+':'+pad(startDate.getMinutes()),
          end:pad(endDate.getHours())+':'+pad(endDate.getMinutes()),
          rem:rem,repeat:'none',notes:''};
        state.events.push(ev);
      });
      saveEvents();
      $('#readSummary').textContent = 'Plano criado com '+days.length+' dias a partir de '+start+'.';
    }
    function wipeReadPlan(){
      var before=state.events.length; state.events=state.events.filter(function(e){return e.cat!=='leitura'}); var removed=before-state.events.length; saveEvents();
      $('#readSummary').textContent= removed>0? ('Removidos '+removed+' eventos de Leitura.') : 'Nenhum evento de Leitura para remover.';
    }

    // Tema
    function setTheme(name){
      if(name==='slate'){ document.documentElement.removeAttribute('data-theme'); }
      else { document.documentElement.setAttribute('data-theme', name); }
      localStorage.setItem('theme_v1', name);
    }
    function initTheme(){
      var t=localStorage.getItem('theme_v1')||'slate';
      if(t!=='slate') document.documentElement.setAttribute('data-theme', t);
      $('#themeSelect').value=t;
    }

    // Binds
    document.addEventListener('DOMContentLoaded', function(){
      try{
        $('#btnPrev').onclick = function(){ state.weekStart=addDays(state.weekStart,-7); render(); };
        $('#btnNext').onclick = function(){ state.weekStart=addDays(state.weekStart, 7); render(); };
        $('#btnNew').onclick  = function(){ openEventModal(); };
        $('#btnExport').onclick= exportJSON;
        $('#btnImport').onclick= function(){ $('#fileImport').click(); };
        $('#fileImport').addEventListener('change', function(e){ var f=e.target.files&&e.target.files[0]; if(f) importJSON(f); e.target.value=''; });
        $('#btnPerms').onclick = ensurePerms;

        $('#btnDelete').onclick = deleteFromForm;
        $('#btnSave').onclick = function(e){ e.preventDefault(); saveFromForm(); };
        $('#f_repeat').addEventListener('change', updateRepeatCountState);
        $('#themeSelect').addEventListener('change', function(e){ setTheme(e.target.value); });

        function showProfileBlocks(){ var isAux=$('#p_type').value==='pr_aux'; $('#auxBlock').style.display=isAux?'block':'none'; $('#auxMonthOnlyBlock').style.display=isAux?'block':'none'; }
        $('#btnProfile').onclick = function(){ 
          $('#p_type').value=state.profile.type; 
          $('#p_custom').value=(state.profile.customTarget!=null?state.profile.customTarget:''); 
          $('#p_auxTarget').value=state.profile.auxTarget; 
          $('#p_auxOnly').value=state.profile.auxOnly?'yes':'no'; 
          showProfileBlocks(); openDialog($('#dlgProfile')); 
        };
        $('#p_type').addEventListener('change', showProfileBlocks);
        $('#btnSaveProfile').onclick = function(e){
          e.preventDefault();
          var p=state.profile;
          p.type=$('#p_type').value;
          var ct=parseInt($('#p_custom').value,10); p.customTarget=(ct>0? ct : null);
          p.auxTarget=parseInt($('#p_auxTarget').value,10)||15;
          p.auxOnly=$('#p_auxOnly').value==='yes';
          if(p.type==='pr_aux' && p.auxOnly){ p.auxMonth=ymKey(new Date()); }
          saveProfile();
          closeDialog($('#dlgProfile'));
        };
        $('#btnResetMonth').onclick= function(){ var now=new Date(), ym=ymKey(now); var before=state.events.length; state.events=state.events.filter(function(e){return !(e.cat==='ministerio' && e.date && e.date.indexOf(ym)===0)}); saveEvents(); };

        $('#tStart').onclick=timerStart; $('#tPause').onclick=timerPause; $('#tReset').onclick=timerReset; $('#tSave').onclick=timerSaveToCalendar;

        function toggleReadMethod(){ var personalized=$('#r_type').value==='personalizado'; $('#r_personalized').style.display=personalized?'block':'none'; var isCapDia=($('#r_method').value==='cap_dia'); $('#r_capdia').style.display=personalized&&isCapDia?'block':'none'; $('#r_dias').style.display=personalized&&!isCapDia?'block':'none'; }
        $('#btnRead').onclick= function(){ 
          $('#r_type').value='anual'; $('#r_start').value=todayYMD(); $('#r_method').value='cap_dia';
          $('#r_chapsPerDay').value=3; $('#r_totalDays').value=365; $('#r_time').value='07:00'; $('#r_minPerDay').value=30; $('#r_rem').value=10;
          toggleReadMethod(); openDialog($('#dlgRead')); 
        };
        $('#r_type').addEventListener('change', toggleReadMethod);
        $('#r_method').addEventListener('change', toggleReadMethod);
        $('#btnGenRead').onclick=function(e){ e.preventDefault(); genReadPlan(); closeDialog($('#dlgRead')); };
        $('#btnWipeRead').onclick=function(e){ e.preventDefault(); wipeReadPlan(); };
        $('#btnClearRead').onclick=function(e){ e.preventDefault(); wipeReadPlan(); };

        render(); scheduleAllAlarms(); initTheme(); updateDashboard(); timerUpdate();

        if(state.events.length===0){
          var addFixed=function(title,cat,weekday,time,minutesBefore){
            var base=startOfWeek(new Date()); var d=addDays(base,weekday); var ymd=d.toISOString().slice(0,10);
            var id=Date.now()+"_fix_"+weekday+time.replace(':','');
            state.events.push({id:id,title:title,cat:cat,date:ymd,start:time,end:time,rem:minutesBefore,repeat:'weekly',notes:''});
          };
          addFixed('Reuni√£o (Quinta)','reuniao',3,'20:00',30);
          addFixed('Reuni√£o (Domingo)','reuniao',6,'19:30',30);
          saveEvents();
        }
      }catch(e){ err('Falha na inicializa√ß√£o: '+e.message); }
    });

    // Timer helpers expostos no escopo
    function timerUpdate(){ $('#timerDisp').textContent = formatHMS(tAccum + (tRunning? Date.now()-tStart : 0)); }
    function formatHMS(ms){ var sec=Math.floor(ms/1000); var h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; return pad(h)+':'+pad(m)+':'+pad(s); }
    function timerStart(){ if(!tRunning){ tRunning=true; tStart=Date.now(); tInterval=setInterval(timerUpdate,500); timerUpdate(); } }
    function timerPause(){ if(tRunning){ tAccum += Date.now()-tStart; tRunning=false; clearInterval(tInterval); timerUpdate(); } }
    function timerReset(){ tRunning=false; clearInterval(tInterval); tAccum=0; tStart=0; timerUpdate(); }
  })();
  </script>
</body>
</html>
